# 📋 Android App 開發 Todo List

## 🎯 開發階段規劃

### ✅ 階段一：基礎功能（已完成）
- [x] BLE 連接功能
- [x] 資料接收與解析
- [x] 基礎 UI 顯示

### ✅ 階段二：零點校正功能（已完成）

#### 2.1 校正管理器
- [x] 創建 `CalibrationManager.java`
  - [x] 實現資料收集邏輯（收集 200 筆資料）
  - [x] 實現偏移量計算邏輯
  - [x] 實現校正值儲存（SharedPreferences + Gson）
  - [x] 實現校正值載入
  - [x] 實現校正值應用（校正原始資料）

#### 2.2 校正資料模型
- [x] 創建 `CalibrationData.java`
  - [x] 定義校正資料結構（6軸偏移量 + 時間戳）
  - [x] 實現 JSON 序列化/反序列化（使用 Gson）

#### 2.3 校正 UI
- [x] 在主介面添加「零點校正」按鈕
- [x] 實現校正進度顯示（TextView 顯示進度）
- [x] 實現校正完成/取消功能
- [x] 添加校正狀態指示器

#### 2.4 校正邏輯整合
- [x] 在 `MainActivity` 整合校正功能
- [x] 確保所有顯示的資料都經過校正
- [x] 確保圖表顯示的資料都經過校正
- [ ] 確保上傳的資料都經過校正（待 Firebase 整合時完成）

### ✅ 階段三：曲線圖顯示（已完成）

#### 3.1 圖表庫整合
- [x] 添加 MPAndroidChart 依賴（v3.1.0）
- [x] 創建 `ChartManager.java`
  - [x] 實現資料降採樣（50Hz → 10Hz，每 100ms 取最新資料）
  - [x] 實現資料緩衝（維持 5 秒資料，約 50 個資料點）
  - [x] 實現圖表更新邏輯（使用 Handler 定時更新）

#### 3.2 圖表視圖
- [x] 使用 XML 佈局（activity_main.xml）
- [x] 實現 6 個獨立 LineChart
  - [x] 加速度 X 軸圖表（藍色 #2196F3）
  - [x] 加速度 Y 軸圖表（綠色 #4CAF50）
  - [x] 加速度 Z 軸圖表（紫色 #9C27B0）
  - [x] 角速度 X 軸圖表（橙色 #FF9800）
  - [x] 角速度 Y 軸圖表（紅色 #F44336）
  - [x] 角速度 Z 軸圖表（青色 #00BCD4）
- [x] 設定圖表樣式（顏色、軸標籤、網格、Cubic Bezier 平滑）
- [x] 實現圖表平滑滾動（自動縮放 X 軸範圍）

#### 3.3 圖表互動
- [ ] 實現圖表顯示/隱藏切換（待實作）
- [ ] 實現圖表暫停/繼續功能（待實作）
- [ ] 實現圖表清除功能（待實作）

#### 3.4 圖表性能優化
- [x] 限制圖表更新頻率（每 100ms 更新一次）
- [x] 優化圖表渲染性能（使用 Handler 在主線程更新）
- [x] 實現資料點數限制（最多 50 個點，自動移除舊資料）

### ✅ 階段四：Firebase 資料上傳（已完成）

#### 4.1 Firebase 設定
- [x] 建立 Firebase 專案
- [x] 下載 `google-services.json`
- [x] 配置 Firebase 依賴
- [x] 初始化 Firebase

#### 4.2 Firebase 管理器
- [x] 創建 `FirebaseManager.java`
  - [x] 初始化 Firestore
  - [x] 實現批次上傳邏輯
  - [x] 實現上傳狀態管理
  - [x] 實現錯誤處理

#### 4.3 資料上傳邏輯
- [x] 實現資料批次收集（整合在 FirebaseManager 中）
  - [x] 實現上傳觸發條件（5秒或100筆）
  - [x] 實現資料格式轉換
  - [ ] 實現上傳重試機制（待實作：離線資料儲存）

#### 4.4 本地資料庫（待實作）
- [ ] 創建 Room 資料庫
  - [ ] 定義 `IMUDataEntity`
  - [ ] 定義 `IMUDataDao`
  - [ ] 定義 `AppDatabase`
- [ ] 實現離線資料儲存
- [ ] 實現上傳失敗資料的本地儲存
- [ ] 實現網路恢復時自動重新上傳

#### 4.5 上傳模式控制
- [x] 添加「測試/錄製模式」切換
- [x] 實現僅在錄製模式下上傳
- [x] 添加錄製狀態指示器
- [x] 添加 session_id 生成邏輯

#### 4.6 UI 整合
- [x] 添加「開始錄製」/「停止錄製」按鈕
- [x] 顯示錄製狀態（錄製中/已停止）
- [ ] 顯示上傳狀態（成功/失敗/待上傳）（可在 Logcat 查看）
- [ ] 顯示上傳進度（待實作）
- [ ] 顯示待上傳資料數量（待實作）

### 🤖 階段五：遠端 AI 辨識

#### 5.1 動作偵測
- [ ] 創建 `ActionDetector.java`
  - [ ] 實現加速度峰值偵測
  - [ ] 實現角速度峰值偵測
  - [ ] 實現動作觸發邏輯
  - [ ] 調整偵測閾值

#### 5.2 辨識管理器
- [ ] 創建 `RecognitionManager.java`
  - [ ] 實現 40 筆資料窗口管理
  - [ ] 實現 HTTP 請求發送
  - [ ] 實現辨識結果解析
  - [ ] 實現錯誤處理

#### 5.3 辨識結果模型
- [ ] 創建 `RecognitionResult.java`
  - [ ] 定義辨識結果結構（姿態、信心度、球速）
  - [ ] 實現 JSON 解析

#### 5.4 辨識結果顯示
- [ ] 創建辨識結果卡片 UI
- [ ] 實現結果動畫效果（彈出、淡入）
- [ ] 實現結果凍結顯示（3-5秒）
- [ ] 實現不同姿態的顏色區分
- [ ] 實現球速顯示（僅殺球時）

#### 5.5 球速計算
- [ ] 實現球速計算邏輯
  - [ ] 根據加速度峰值計算
  - [ ] 根據實際測試調整係數
- [ ] 顯示球速單位（km/h）

### 🎨 階段六：UI/UX 優化

#### 6.1 主介面設計
- [ ] 重新設計主介面佈局
  - [ ] 頂部狀態欄
  - [ ] 連接控制區
  - [ ] 即時資料顯示區
  - [ ] 曲線圖顯示區
  - [ ] 辨識結果顯示區
  - [ ] 控制按鈕區
- [ ] 應用 Material Design 3 設計語言
- [ ] 設定色彩主題
- [ ] 優化間距和排版

#### 6.2 動畫效果
- [ ] 連接狀態動畫
- [ ] 資料更新動畫
- [ ] 辨識結果動畫
- [ ] 圖表更新動畫

#### 6.3 響應式設計
- [ ] 適配不同螢幕尺寸
- [ ] 適配橫屏/豎屏
- [ ] 優化滾動體驗

#### 6.4 設定頁面
- [ ] 創建 `SettingsActivity`
- [ ] 添加零點校正按鈕
- [ ] 添加 Firebase 設定
- [ ] 添加上傳模式切換
- [ ] 添加關於資訊

### 🧪 階段七：測試與優化

#### 7.1 功能測試
- [ ] BLE 連接測試
- [ ] 零點校正測試
- [ ] 資料顯示測試
- [ ] 圖表顯示測試
- [ ] Firebase 上傳測試
- [ ] 辨識功能測試

#### 7.2 性能優化
- [ ] 記憶體使用優化
- [ ] CPU 使用優化
- [ ] 電池消耗優化
- [ ] 網路請求優化

#### 7.3 錯誤處理
- [ ] 完善錯誤處理邏輯
- [ ] 添加錯誤日誌
- [ ] 添加使用者友好的錯誤提示

---

## 📝 開發優先順序

### 第一優先（必須完成）
1. ✅ BLE 連接功能
2. ✅ 零點校正功能
3. ✅ 即時資料顯示
4. ✅ 曲線圖顯示
5. ✅ 電壓監控與濾波
6. ✅ Firebase 資料上傳（基本功能已完成）

### 第二優先（重要功能）
5. ⏳ Firebase 資料上傳
6. ⏳ 本地資料庫
7. ⏳ 上傳模式控制

### 第三優先（進階功能）
8. ⏳ 動作偵測
9. ⏳ 遠端辨識
10. ⏳ 辨識結果顯示

### 第四優先（優化）
11. ⏳ UI/UX 優化
12. ⏳ 動畫效果
13. ⏳ 性能優化

---

## 🔧 技術債務

- [ ] 代碼重構和優化
- [ ] 添加單元測試
- [ ] 添加整合測試
- [ ] 完善錯誤處理
- [ ] 添加日誌系統
- [ ] 完善文檔註釋

---

## 📌 注意事項

1. **零點校正**：確保校正邏輯正確，特別是 Z 軸減去 1g 的處理
2. **圖表性能**：注意圖表更新頻率，避免 UI 卡頓
3. **Firebase 上傳**：注意批次上傳的時機和頻率，避免過度消耗資源
4. **網路請求**：實現適當的超時和重試機制
5. **資料同步**：確保本地資料和 Firebase 資料的一致性

---

---

## ✅ 已完成功能詳細說明

### 電壓監控與濾波功能（2025-01-24 新增）

#### 電壓讀取優化
- **Arduino 端**：
  - 電壓讀取頻率從 50Hz 降低到每 10 秒一次
  - 每次讀取 30 筆電壓值並取平均，提高讀數穩定性
  - 使用 `readVoltageAverage()` 函數實現
  - 讀取時啟用分壓電路（P0.14 = LOW），讀取完畢立即關閉以省電

#### 電壓濾波器
- **Android 端**：
  - 創建 `VoltageFilter.java` 類別
  - 使用雙層濾波架構：
    1. 第一層：大視窗移動平均（100 個樣本，約 2 秒）
    2. 第二層：指數移動平均（EMA，alpha = 0.15）
  - 大幅減少電壓跳動，提供穩定的電壓讀數
  - 自動過濾異常值（< 0.1V 或 > 5.0V）

#### 電壓校準
- **校準常數**：8.11（根據實際測量值調整）
- **校準公式**：`V_BAT = RESULT × 8.11 / 4096`
- **電壓範圍**：2.5V - 4.5V（電池 501230, 3.7V, 150mAh）
- **異常檢測**：自動檢測 USB 供電模式或讀取錯誤（> 5.0V）

#### UI 顯示
- 顯示格式：`電壓: X.XXX V (原始: X.XXX V)`
- 同時顯示濾波後的值和原始值，方便觀察濾波效果

---

**最後更新**: 2025年1月24日

