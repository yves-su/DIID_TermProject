# ğŸ¸ Arduinoæ™ºèƒ½ç¾½æ¯›çƒæ‹æ„Ÿæ¸¬å™¨å°ˆæ¡ˆ (V3.0 å³æ™‚è¾¨è­˜ç‰ˆ)

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°

æœ¬å°ˆæ¡ˆæ˜¯ä¸€å€‹åŸºæ–¼Arduinoçš„æ™ºèƒ½ç¾½æ¯›çƒæ‹æ„Ÿæ¸¬å™¨ç³»çµ±ï¼Œèƒ½å¤ å³æ™‚åµæ¸¬å’Œåˆ†é¡ç¾½çƒæ“Šçƒå‹•ä½œï¼ˆSmashæ®ºçƒã€DriveæŠ½çƒã€TossæŒ‘çƒã€DropåŠçƒã€Otherå…¶ä»–ï¼‰ã€‚
**V3.0 é‡å¤§æ›´æ–°**ï¼šå¾é›¢ç·šè³‡æ–™æ”¶é›†è½‰å‹ç‚º**å³æ™‚é›²ç«¯è¾¨è­˜ç³»çµ±**ã€‚MCU è² è²¬æ¡æ¨£ï¼Œæ‰‹æ©Ÿ APP è² è²¬ä¸­ç¹¼èˆ‡é¡¯ç¤ºï¼Œé›²ç«¯ä¼ºæœå™¨ (PyTorch) è² è²¬ AI æ¨è«–èˆ‡çƒé€Ÿé‹ç®—ã€‚

## ğŸ¯ å°ˆæ¡ˆç›®æ¨™

- **å³æ™‚æ€§**: æ“Šçƒå¾Œæ¯«ç§’ç´šé¡¯ç¤ºè¾¨è­˜çµæœ
- **ç²¾ç¢ºæ€§**: ä½¿ç”¨ Server-side PyTorch æ¨¡å‹é€²è¡Œé«˜ç²¾åº¦ FCN æ¨è«–
- **æ¶æ§‹**: MCU -> APP (BLE) -> Server (WebSocket) -> APP
- **é«”é©—**: åªæœ‰åœ¨ã€Œæ®ºçƒ (Smash)ã€ç™¼ç”Ÿæ™‚ï¼Œæ‰é¡¯ç¤ºçƒé€Ÿèˆ‡ç‰¹æ•ˆ

## ğŸ”§ ç¡¬é«”è¨­è¨ˆ (ä¸è®Š)

### æ ¸å¿ƒçµ„ä»¶

| çµ„ä»¶   | å‹è™Ÿ                      | å°ºå¯¸         | åŠŸèƒ½                       |
| ------ | ------------------------- | ------------ | -------------------------- |
| ä¸»æ§æ¿ | Seeed XIAO nRF52840 Sense | 20Ã—17.5Ã—5 mm | ä¸»æ§åˆ¶å™¨ï¼Œæ”¯æ´BLE 5.0      |
| æ„Ÿæ¸¬å™¨ | LSM6DS3TR                 | -            | å…­è»¸IMUï¼ˆåŠ é€Ÿåº¦è¨ˆ+é™€èºå„€ï¼‰ |
| é›»æ±    | 501230                    | -            | 3.7V é‹°é›»æ± ï¼Œ150mAh        |

## ğŸ“¡ ç³»çµ±é€šè¨Šå”å®š (New)

### 1. BLE é€šè¨Š (MCU <-> APP)

- **Service UUID**: `0769bb8e-b496-4fdd-b53b-87462ff423d0`
- **IMU Data Characteristic (Notify)**: `8ee82f5b-76c7-4170-8f49-fff786257090`
- **Time Sync Characteristic (Write)**: `8ee82f5b-76c7-4170-8f49-fff786257091` (æ–°å¢—)

#### è³‡æ–™å°åŒ…çµæ§‹ (34 Bytes, Little Endian)

| Byte Index | æ¬„ä½åç¨±     | é¡å‹       | èªªæ˜                               |
| :--------: | :----------- | :--------- | :--------------------------------- |
|    0-3     | Timestamp    | `uint32_t` | Unix Timestamp (ç§’)ï¼Œéœ€ç”± APP æ ¡æ­£ |
|    4-5     | Milliseconds | `uint16_t` | æ¯«ç§’ (0~999)                       |
|    6-9     | Accel X      | `float`    | G (é‡åŠ›åŠ é€Ÿåº¦)                     |
|   10-13    | Accel Y      | `float`    | G                                  |
|   14-17    | Accel Z      | `float`    | G                                  |
|   18-21    | Gyro X       | `float`    | dps (åº¦/ç§’)                        |
|   22-25    | Gyro Y       | `float`    | dps                                |
|   26-29    | Gyro Z       | `float`    | dps                                |
|   30-31    | Voltage      | `uint16_t` | mV (å¦‚ 3700 = 3.7V)                |
|   32-33    | Checksum     | `uint16_t` | ç°¡å–®æ ¡é©—ç¢¼ (XOR sum)               |

#### æ™‚é–“åŒæ­¥æ©Ÿåˆ¶

1. APP é€£ç·šæˆåŠŸå¾Œï¼Œç«‹å³è®€å–ç•¶å‰æ‰‹æ©Ÿæ™‚é–“ (Unix Timestamp)ã€‚
2. å¯«å…¥ **Time Sync Characteristic**ã€‚
3. MCU æ¥æ”¶å¾Œæ›´æ–°å…§éƒ¨ RTCï¼Œä¹‹å¾Œé€å‡ºçš„å°åŒ…å³å¸¶æœ‰æº–ç¢ºçš„çµ•å°æ™‚é–“ã€‚

### 2. é›²ç«¯é€šè¨Š (APP <-> Server)

æ¡ç”¨ **WebSocket** å…¨é›™å·¥é€šè¨Šä»¥é”åˆ°æœ€ä½å»¶é²ã€‚

- **Endpoint**: `ws://<server_ip>/ws/predict`
- **è³‡æ–™æµå‘**:
    1. APP æ¥æ”¶ BLE è³‡æ–™ï¼Œå­˜å…¥ Circular Bufferã€‚
    2. APP åµæ¸¬åˆ°ç¬é–“åŠ é€Ÿåº¦è¶…éé–¥å€¼ (ä¾‹å¦‚ >2G) -> **è§¸ç™¼äº‹ä»¶**ã€‚
    3. APP æ“·å–è§¸ç™¼é»å‰å¾Œçš„è³‡æ–™ (ä¾‹å¦‚ 40-50 frames)ï¼Œæ‰“åŒ…æˆ JSONã€‚
    4. APP é€é WebSocket ç™¼é€ Requestã€‚
    5. Server å›å‚³ Resultï¼ŒAPP æ ¹æ“šæŒ‡ä»¤æ›´æ–° UIã€‚

#### Request (APP -> Server)

```json
{
  "client_id": "user_123",
  "data": [
    {
      "ts": 1715091234.120, // çµ•å°æ™‚é–“
      "acc": [0.1, 2.5, 9.8],
      "gyro": [0.1, -0.2, 0.5]
    },
    // ... å…± N ç­† (Window Size)
  ]
}
```

#### Response (Server -> APP)

```json
{
  "timestamp": 1715091234.120,
  "type": "Smash",       // è­˜åˆ¥çµæœ
  "speed": 185.5,        // çƒé€Ÿ (åƒ… Smash æœ‰å€¼ï¼Œå…¶é¤˜ç‚º 0 æˆ– null)
  "display": true,       // æ˜¯å¦æ›´æ–° UI (Server ç«¯é‚è¼¯æ±ºå®š)
  "message": "KILL SHOT!"
}
```

## ï¿½ ä¼ºæœå™¨ç«¯é‚è¼¯ & AI æ¶æ§‹

### è™•ç†æµç¨‹

1. **è³‡æ–™æ¥æ”¶**: æ¥æ”¶ JSON Window Dataã€‚
2. **å‰è™•ç† (Pre-processing)**: æ­£è¦åŒ–ã€è£œå€¼ã€‚
### AI æ¨¡å‹éƒ¨ç½²ç­–ç•¥ (Deployment Strategy)

ç”±æ–¼ã€Œå‹•ä½œåˆ†é¡ã€èˆ‡ã€Œçƒé€Ÿé æ¸¬ã€æ˜¯ç”±ä¸åŒæ¨¡å‹è² è²¬ï¼ŒServer ç«¯æ¡ç”¨ **ã€Œåºåˆ—åŒ–åŸ·è¡Œ (Sequential Pipeline)ã€** ç­–ç•¥ï¼š

1.  **Model A (Classifier)**: å…ˆåˆ¤æ–·å‹•ä½œé¡å‹ (0.02s)ã€‚
2.  **Model B (Speed Regressor)**: è‹¥å‹•ä½œç‚º Smashï¼Œæ‰è¼‰å…¥ Input åŸ·è¡Œçƒé€Ÿé æ¸¬ (0.01s)ã€‚
    *   **å„ªé»**: ç¯€çœé‹ç®—è³‡æºï¼Œéæ®ºçƒå‹•ä½œä¸éœ€è¦è·‘çƒé€Ÿæ¨¡å‹ã€‚
    *   **ç©©å®šæ€§**: ç”±æ–¼æ˜¯ **"Event-Driven"** (æ¯æ¬¡æ®æ‹åªè§¸ç™¼ä¸€æ¬¡è¨ˆç®—)ï¼Œçµæœæœƒæ˜¯ä¸€å€‹å›ºå®šçš„æ•¸å€¼ï¼Œä¸æœƒåœ¨ç•«é¢ä¸Šè·³å‹•ã€‚

### è™•ç†æµç¨‹
1.  **è³‡æ–™æ¥æ”¶**: æ¥æ”¶ JSON Window Data (ä¾‹å¦‚ 50 frames)ã€‚
2.  **å‰è™•ç† (Pre-processing)**: æ­£è¦åŒ–ã€è£œå€¼ã€‚
3.  **å‹•ä½œåˆ†é¡ (Model A)**:
    - Input: `(Batch, 6, Window_Size)`
    - Output: `Class Probabilities` (Smash, Drive, Others...)
4. **å•†æ¥­é‚è¼¯ (Business Logic)**:
    - `IF (Confidence > Threshold)`:
        - è¨­å®š `display = true`ã€‚
        - `IF (Type == Smash)`:
            - åŸ·è¡Œ **çƒé€Ÿå›æ­¸æ¨¡å‹ (Speed Regressor)**ã€‚
            - å›å‚³ `speed` (ä¾‹å¦‚ 180.5)ã€‚
        - `ELSE`:
            - `speed` ç‚º `null`ï¼Œåƒ…å›å‚³ `Type`ã€‚
    - `ELSE` (ä¿¡å¿ƒä¸è¶³):
        - è¨­å®š `display = false`ã€‚
5. **å›å‚³çµæœ**: JSON Responseã€‚

## ï¿½ é–‹ç™¼ç’°å¢ƒè¨­å®š

### 1. Arduino (MCU)

* **Board**: Seeed XIAO nRF52840 Sense
- **Libraries**: ArduinoBLE, Seeed_Arduino_LSM6DS3

### 2. Server (Backend)

* **Language**: Python 3.9+
- **Framework**: FastAPI (Web/WebSocket)
- **AI**: PyTorch
- **æ¸¬è©¦å·¥å…·**: `tools/simulate_app.py` (æ¨¡æ“¬ APP è¡Œç‚º)

### 3. APP (Frontend)

* **Platform**: Android / Flutter
- **Role**: BLE Central, WebSocket Client

## ğŸ“ å°ˆæ¡ˆçµæ§‹ (æ›´æ–°å¾Œ)

```
DIID_TermProject_v2/
â”œâ”€â”€ README.md               # æœ¬æ–‡ä»¶
â”œâ”€â”€ server/                 # Python ä¼ºæœå™¨ç«¯ (FastAPI)
â”œâ”€â”€ smart_racket_app/       # [NEW] Flutter APP å°ˆæ¡ˆæ ¹ç›®éŒ„
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ main.dart       # APP ä¸»ç¨‹å¼
â”‚   â””â”€â”€ pubspec.yaml        # Flutter ä¾è³´è¨­å®š
â”œâ”€â”€ tools/                  # æ¸¬è©¦å·¥å…· (simulate_app.py)
â”œâ”€â”€ src/                    # MCU éŸŒé«”æºç¢¼
â””â”€â”€ docs/                   # æ–‡ä»¶
```

## ğŸ‘¥ å°ˆæ¡ˆåœ˜éšŠ

- **ç¡¬é«”è¨­è¨ˆ**: è˜‡æ˜±å½°ã€å¼µç¾¿è»’
- **Arduinoç¨‹å¼**: è˜‡æ˜±å½°ã€å¼µç¾¿è»’
- **æ‰‹æ©ŸAppé–‹ç™¼**: è¨±ä¿Šç‘‹
- **AIæ¨¡å‹è¨­è¨ˆ**: æ±Ÿè© ç¿”ã€è²»å“ˆè˜‡
- **UIè¨­è¨ˆ**:ææ˜Šæ†
- **è³‡æ–™æ”¶é›†ï¼†æ¨™è¨˜**: å·«èªŒé¨°

## ğŸ“„ æˆæ¬Š

æœ¬å°ˆæ¡ˆåƒ…ä¾›å­¸ç¿’åƒè€ƒä½¿ç”¨ã€‚
